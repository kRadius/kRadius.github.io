<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="夫博观而约取，厚积而薄发">
<meta property="og:type" content="website">
<meta property="og:title" content="StoryBoard">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="StoryBoard">
<meta property="og:description" content="夫博观而约取，厚积而薄发">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="StoryBoard">
<meta name="twitter:description" content="夫博观而约取，厚积而薄发">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> StoryBoard </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">StoryBoard</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">iOS | github | hexo</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            标签
          </a>
        </li>
      

      


      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/12/03/RN下拉刷新解决方案/" itemprop="url">
                  RN下拉刷新解决方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-12-03T21:58:21+08:00" content="2017-12-03">
              2017-12-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/RN/" itemprop="url" rel="index">
                    <span itemprop="name">RN</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="RN__u7684_u4E0B_u62C9_u5237_u65B0_u89E3_u51B3_u65B9_u6848"><a href="#RN__u7684_u4E0B_u62C9_u5237_u65B0_u89E3_u51B3_u65B9_u6848" class="headerlink" title="RN 的下拉刷新解决方案"></a>RN 的下拉刷新解决方案</h2><h3 id="u80CC_u666F"><a href="#u80CC_u666F" class="headerlink" title="背景"></a>背景</h3><p>写过 RN 的同学都知道，RN 的下拉刷新是一个比较头疼的事儿。问题在于 RN 的 FlatList 用的是系统的 RefreshControl,很难自定义。所以想要做成和 Native 一样的可精细化控制的下拉刷新效果，确实得费一些心思。本文的背景：</p>
<ul>
<li>RN 0.49 版本（FB 已经改了协议），</li>
<li>Xcode 9</li>
<li>Native 的 App 中只有一部分内容是 RN </li>
</ul>
<h3 id="u6548_u679C"><a href="#u6548_u679C" class="headerlink" title="效果"></a>效果</h3><p>我们要实现的目标是：给 ListView、FlatList 都加上小团的下拉刷新效果，实现的效果如下：<br><span style="display:block;text-align:center"><img src="http://7xpoeq.com1.z0.glb.clouddn.com/2017-12-02%2021_45_23.gif" width="50%" style="display:inline"></span></p>
<h3 id="u601D_u8DEF"><a href="#u601D_u8DEF" class="headerlink" title="思路"></a>思路</h3><p>写这文章的时候，我接触 ES、React、RN 时间不到一个月，所以限制我的想象力的是对于 JS 的熟练程度。本文是在 Native 端做的文章。</p>
<p>先说下思路：我们发现，所有的 ScrollView、ListView、FlatList 最终现实在 Native 上都是一个 RCTScrollView，这虽然是一个自定义的 View，但暴露了一个 ReadOnly 的 ScrollView 属性，这也是一个自定义的 ScrollView。</p>
<p><strong>实现的最主要思路就是给这个 ScrollView 加上 Native 的下拉刷新，然后暴露属性控制是否要用自定义的属性。</strong></p>
<h3 id="u8981_u505A_u7684_u5DE5_u4F5C"><a href="#u8981_u505A_u7684_u5DE5_u4F5C" class="headerlink" title="要做的工作"></a>要做的工作</h3><p>要实现这个效果，需要准备一个可以给 ScrollView 加上的通用下拉刷新控件（Native 端的）。你可以自定义一个，或者用 SVPullRefresh、MJRefresh 啥的。对于源码，我们的原则是尽量不做修改，因为修改源码可能会因个人的实际情况有不用程度的问题。不过像笔者这种原先纯 Native 的 App，中途只有一部分改用 RN 的情况，还是建议保存一份 RN 的源码保存在私有仓库，因为肯定在某些场景下不能满足自身的需求。</p>
<h4 id="Native__u7AEF"><a href="#Native__u7AEF" class="headerlink" title="Native 端"></a>Native 端</h4><p>代码方面我们只需要<strong>改一行 RN 的源码</strong>，不需要改 RN Native 端的代码。</p>
<p>第一步要做的事情是给 <code>RCTScrollView</code> 和 <code>RCTScrollViewManager</code> 加上对应的 Category，用途是给 RCTScrollView 暴露新的属性以及控制自定义属性的行为。一般来说只要三个属性：</p>
<ul>
<li>enableCustomRefresh 控制是否需要显示自定义的下拉刷新</li>
<li>isCustomRefreshing 控制下拉刷新的状态</li>
<li>onCustomRefreshing 控制下拉刷新的回调</li>
</ul>
<p>我们知道 OC 可以通过 AssociateObject 给类添加 property，所以 Native 暴露的属性，JS 端通过 RN 调用的时候，都可以动态的找到对应的 setter/getter。这就是为啥我们前面说不用修改 RN Native 端源码的原因。最终实现的 Sample 代码：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RCTScrollViewManager+SRNPullRefresh</span></span><br><span class="line"><span class="variable">@interface</span> RCTScrollViewManager (SRNPullRefresh)</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br><span class="line"></span><br><span class="line"><span class="variable">@implementation</span> RCTScrollViewManager (SRNPullRefresh)</span><br><span class="line"></span><br><span class="line"><span class="comment">// cumtom refresh</span></span><br><span class="line"><span class="function">RCT_EXPORT_VIEW_PROPERTY</span>(onSRNRefreshData, RCTDirectEventBlock)</span><br><span class="line"><span class="function">RCT_EXPORT_VIEW_PROPERTY</span>(enableSRNPullToRefresh, BOOL)</span><br><span class="line"><span class="function">RCT_EXPORT_VIEW_PROPERTY</span>(isSRNRefreshing, BOOL)</span><br><span class="line"></span><br><span class="line"><span class="variable">@end</span></span><br></pre></td></tr></table></figure>
<figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//RCTScrollView+SRNPullRefresh.h</span></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RCTScrollView</span> (<span class="title">SRNPullRefresh</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - CustomRefresh</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> enableSRNPullToRefresh;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">assign</span>) <span class="built_in">BOOL</span> isSRNRefreshing;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) RCTDirectEventBlock onSRNRefreshData;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//RCTScrollView+SRNPullRefresh.m</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">RCTScrollView</span> (<span class="title">SRNPullRefresh</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="preprocessor">#pragma mark - Property</span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setIsSRNRefreshing:(<span class="built_in">BOOL</span>)isSRNRefreshing &#123;</span><br><span class="line">	<span class="comment">// 此处控制具体的刷新控件是否要开始刷新</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(isSRNRefreshing), @(isSRNRefreshing), OBJC_ASSO<span class="built_in">CIATION_RETAIN_NONATOMIC</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)isSRNRefreshing &#123;</span><br><span class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(isSRNRefreshing)) boolValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setEnableSRNPullToRefresh:(<span class="built_in">BOOL</span>)enableSRNPullToRefresh &#123;</span><br><span class="line">	 <span class="comment">// 此处给 self.scrollView 加上对应的下拉刷新控件</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(enableSRNPullToRefresh), @(enableSRNPullToRefresh), OBJC_ASSO<span class="built_in">CIATION_RETAIN_NONATOMIC</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)enableSRNPullToRefresh &#123;</span><br><span class="line">    <span class="keyword">return</span> [objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(enableSRNPullToRefresh)) boolValue];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setOnSRNRefreshData:(RCTDirectEventBlock)onSRNRefreshData &#123;</span><br><span class="line">	<span class="comment">// 此处应该调用暴露的 block 属性，让 JS 的刷新方法得到调用</span></span><br><span class="line">    objc_setAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(onSRNRefreshData), onSRNRefreshData, OBJC_ASSO<span class="built_in">CIATION_COPY_NONATOMIC</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (RCTDirectEventBlock)onSRNRefreshData &#123;</span><br><span class="line">    <span class="keyword">return</span> objc_getAssociatedObject(<span class="keyword">self</span>, <span class="keyword">@selector</span>(onSRNRefreshData));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Native 端的工作就到此。</p>
<h4 id="JS__u7AEF"><a href="#JS__u7AEF" class="headerlink" title="JS 端"></a>JS 端</h4><p>JS 本身就是一个动态的语言，可以通过 protoType 在运行时给一个 object 添加属性和方法。所以我们可能想到，可以给 RN 的组件（JS 的组件，下文没有做特别说明都是指 JS 的）添加相关的属性，对应 Native 暴露的属性。</p>
<p>不过很遗憾，RN 对于他自己提供的组件，会有一个严格的类型检查。<strong>如果 Native 暴露的属性，在 JS 端没有对应的属性声明，在 debug 环境下会抛出一个 Error。</strong></p>
<p>这是 JS 端未做处理的情况：<br><span style="display:block;text-align:center"><img src="http://7xpoeq.com1.z0.glb.clouddn.com/RN%E6%8A%A5%E9%94%99.png" width="50%" style="display:inline"></span></p>
<p>查看源码我们发现，在验证失败的时候会抛出一个 Error。而且，这类型的检查发生在 require native component 的时候，这早于我们一般添加 protoType 的时机。</p>
<p><span style="display:block;text-align:center"><img src="http://7xpoeq.com1.z0.glb.clouddn.com/1512306803060-image.png" width="50%" style="display:inline"></span></p>
<p>这是 ScrollView.js 的调用：</p>
<p><span style="display:block;text-align:center"><img src="http://7xpoeq.com1.z0.glb.clouddn.com/scrollView_js.png" width="50%" style="display:inline"></span></p>
<p>不过这个检查只会发生在 Debug 环境下，所以，此时我们有两种解决方案：</p>
<ol>
<li>给 ScrollView 加上这几个我们自定义的 props</li>
<li>把这个 <code>throw new Error(message)</code> 给注释掉或者改成 <code>console.warn(message)</code>。</li>
</ol>
<p>我们推荐第二种方式，第一、肯定不能丢失 Debug 的功能。第二、以后可能还有又类似的功能，这样做不需要每次都去改相关的组件代码。</p>
<p>做完了这些，你在用到了 FlatList、ListView 之类的 ScrollView 时，只需要给组件加上相关的属性，即可以实现我们开头所讲的那个效果了。</p>
<h3 id="u601D_u8003"><a href="#u601D_u8003" class="headerlink" title="思考"></a>思考</h3><p>后来和一个朋友沟通的时候，他提出了一个方案：可以 hook requireNativeComponent 方法，判断参数是不是 <code>RCTScrollView</code>，然后加上相应的 nativeOnly 参数。这个想法其实挺不错的，又可以不改动源码。不过我们当时因为时间的压力，采用我之前那种成本较小的做法，有时间的话可以尝试着 hook 一下。<br>Have Fun XD ～</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/12/07/支付宝iOS面试/" itemprop="url">
                  支付宝iOS面试
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-07T20:12:29+08:00" content="2016-12-07">
              2016-12-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/面试/" itemprop="url" rel="index">
                    <span itemprop="name">面试</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上来先问，项目结构是怎么样的，这个我事先画过一遍，大概把项目的分层说了一遍<br>然后引申出一系列的问题</p>
<h4 id="u7B2C_u4E00_u4E2A_u662F_u57CB_u70B9_uFF0C_u9879_u76EE_u4E2D_u7684_u57CB_u70B9_u662F_u600E_u4E48_u8BBE_u8BA1_u5B9E_u73B0_uFF1F"><a href="#u7B2C_u4E00_u4E2A_u662F_u57CB_u70B9_uFF0C_u9879_u76EE_u4E2D_u7684_u57CB_u70B9_u662F_u600E_u4E48_u8BBE_u8BA1_u5B9E_u73B0_uFF1F" class="headerlink" title="第一个是埋点，项目中的埋点是怎么设计实现？"></a>第一个是埋点，项目中的埋点是怎么设计实现？</h4><p>一般是实时push。因为并不是要统计所有的行为。如果要统计所有的行为，有没有考虑放到本地，因为可能网络状况不好，导致埋点统计失败。然后是如果放到本地，应该怎么去设计<br>=&gt;数据库，因为量可能会很大。<br>那么如果日志量很大，本地如果有20w条日志记录，应该怎么push到服务端?怎么去取本地的数据？怎么发送到服务端？如果中途失败了、或者Crash了应该如何处理？</p>
<h4 id="u7B2C_u4E8C_u4E2A_uFF0C_u5148_u662F_u95EE_u6211_u4EEC_u9879_u76EE_u4E2D_u7684_u6570_u636E_u6301_u4E45_u5C42_u90FD_u662F_u600E_u4E48_u505A_u7684_uFF1F_u7136_u540E_u6570_u636E_u5E93_u662F_u600E_u4E48_u4FDD_u8BC1_u4E8B_u52A1_u7684_u539F_u5B50_u6027_uFF1F_u5728commit_u4E4B_u524D_uFF0C_u90FD_u5728_u54EA_u513F_u5E72_u4E86_u4EC0_u4E48_u4E8B_u60C5_uFF1F_u591A_u7EBF_u7A0B_u8BBF_u95EE_u6570_u636E_u5E93_u600E_u4E48_u4FDD_u8BC1_u5B89_u5168_uFF1F"><a href="#u7B2C_u4E8C_u4E2A_uFF0C_u5148_u662F_u95EE_u6211_u4EEC_u9879_u76EE_u4E2D_u7684_u6570_u636E_u6301_u4E45_u5C42_u90FD_u662F_u600E_u4E48_u505A_u7684_uFF1F_u7136_u540E_u6570_u636E_u5E93_u662F_u600E_u4E48_u4FDD_u8BC1_u4E8B_u52A1_u7684_u539F_u5B50_u6027_uFF1F_u5728commit_u4E4B_u524D_uFF0C_u90FD_u5728_u54EA_u513F_u5E72_u4E86_u4EC0_u4E48_u4E8B_u60C5_uFF1F_u591A_u7EBF_u7A0B_u8BBF_u95EE_u6570_u636E_u5E93_u600E_u4E48_u4FDD_u8BC1_u5B89_u5168_uFF1F" class="headerlink" title="第二个，先是问我们项目中的数据持久层都是怎么做的？然后数据库是怎么保证事务的原子性？在commit之前，都在哪儿干了什么事情？多线程访问数据库怎么保证安全？"></a>第二个，先是问我们项目中的数据持久层都是怎么做的？然后数据库是怎么保证事务的原子性？在commit之前，都在哪儿干了什么事情？多线程访问数据库怎么保证安全？</h4><p>这方面没深究过，我说，我猜大概是有个类似虚表的东西，然后在commit之前的事情都是在这儿做的，如果操作成功了，再去操作实际的数据表，失败之后就回滚操作</p>
<p>回来发现，完全不是这样的:D。原子性是通过Redo/Undo机制的来实现的。比如删除会生成insert，插入会生成delete这些相反的UndoLog，在事务回滚的时候，去执行这些log</p>
<p>具体的看这个<a href="https://www.zhihu.com/question/30272728/answer/95908054" target="_blank" rel="external">https://www.zhihu.com/question/30272728/answer/95908054</a></p>
<p>同步队列，我们的数据库访问层就是用一个SearialQueue去管理所有的操作。</p>
<h4 id="u7B2C_u4E09_u4E2A_uFF0C_Class_A__u7684_A_u65B9_u6CD5_u8981_u8C03_u7528_Class_B_u7684B_u65B9_u6CD5_uFF0CB_u8981_u8C03_u7528A_u7684_uFF0C_u600E_u4E48_u505A_u5230_u5B8C_u5168_u89E3_u8026_uFF1F"><a href="#u7B2C_u4E09_u4E2A_uFF0C_Class_A__u7684_A_u65B9_u6CD5_u8981_u8C03_u7528_Class_B_u7684B_u65B9_u6CD5_uFF0CB_u8981_u8C03_u7528A_u7684_uFF0C_u600E_u4E48_u505A_u5230_u5B8C_u5168_u89E3_u8026_uFF1F" class="headerlink" title="第三个， Class A 的 A方法要调用 Class B的B方法，B要调用A的，怎么做到完全解耦？"></a>第三个， Class A 的 A方法要调用 Class B的B方法，B要调用A的，怎么做到完全解耦？</h4><p>通知啊（不过我一激动居然没想到！！！我猜如果按照这个方向问下去，会涉及到跨线程发通知的事儿）<br>我想的另外方案，加一个M层，然后也不让间接引用（就是M里面import B，创建b的实例也不让）,那么就消息转发吧，可以动态resolveInstanceMethod<br>上述的方式应该是称为“依赖下称”，思路是对的，但是不应该是这么去实现。应该是这样做：M提供解析Class、Target和Action的基本API，给Class B（理解成一个Module）定义一个Category，里面定义好对应的Class和Target，以及使用的API（eg:callBMethodWithParam:），然后A调用M+BCategory里的方法。由M提供的解析C/T/A的API跳转到B去执行真正的方法体。</p>
<h4 id="u7B2C_u56DB_u4E2A_uFF0C_CoreText_uFF0C_u5BCC_u6587_u672C_u7684_u5BFC_u81F4_u7684_u9875_u9762_u5361_u987F_u5E94_u8BE5_u5982_u4F55_u53BB_u89E3_u51B3_uFF1F_u8FD8_u6709_u79BB_u5C4F_u6E32_u67D3_u7684_u95EE_u9898_uFF1F"><a href="#u7B2C_u56DB_u4E2A_uFF0C_CoreText_uFF0C_u5BCC_u6587_u672C_u7684_u5BFC_u81F4_u7684_u9875_u9762_u5361_u987F_u5E94_u8BE5_u5982_u4F55_u53BB_u89E3_u51B3_uFF1F_u8FD8_u6709_u79BB_u5C4F_u6E32_u67D3_u7684_u95EE_u9898_uFF1F" class="headerlink" title="第四个， CoreText，富文本的导致的页面卡顿应该如何去解决？还有离屏渲染的问题？"></a>第四个， CoreText，富文本的导致的页面卡顿应该如何去解决？还有离屏渲染的问题？</h4><p>这个答了个大概，把绘制的任务放在异步线程里，把图层绘制成一个bitmap，然后将bitmap作为layer的backingStore(也就是leyer的contents属性),直接显示出来，还谈到了AsyncDispalyKit的原理</p>
<p>答了离屏渲染的原理，UI的绘制本来是CPU完成的，如果设置了圆角和mask，会导致渲染这个bitmap的时候，需要开辟额外的内存去绘制radius和mask。还有我说在使用系统提供的layer.shouldRaster之后导致图片会失真，变得模糊不清（也问了为什么会这样），然后采用了重新绘制image的方式。<br>谈到怎么去避免离屏渲染，尽量不要设置半透明的层叠视图，因为GPU需要组合这些layerTree，并且要额外的blending这些半透明的视图。</p>
<h4 id="u7B2C_u4E94_u4E2A_uFF0C_u7EBF_u7A0B_u7684_u5B89_u5168_u5E94_u8BE5_u600E_u4E48_u4FDD_u8BC1_uFF1F"><a href="#u7B2C_u4E94_u4E2A_uFF0C_u7EBF_u7A0B_u7684_u5B89_u5168_u5E94_u8BE5_u600E_u4E48_u4FDD_u8BC1_uFF1F" class="headerlink" title="第五个，线程的安全应该怎么保证？"></a>第五个，线程的安全应该怎么保证？</h4><p>加锁，NSLock、NSRecursiveLock等，还有GCD的semaphore信号量机制之类的。</p>
<h4 id="u7B2C_u516D_u4E2A_uFF0C_u5FAE_u4FE1_u5C0F_u7A0B_u5E8F_u7684_u5B9E_u73B0_u539F_u7406_u662F_u5565_uFF1F_u4E3A_u4EC0_u4E48_u8981_u8FD9_u4E48_u505A_uFF1F_uFF08_u4F30_u8BA1_u662F_u770B_u770B_u6211_u6CA1_u6709_u5173_u6CE8_u8FD9_u4E9B_u4E8B_u513F_uFF09"><a href="#u7B2C_u516D_u4E2A_uFF0C_u5FAE_u4FE1_u5C0F_u7A0B_u5E8F_u7684_u5B9E_u73B0_u539F_u7406_u662F_u5565_uFF1F_u4E3A_u4EC0_u4E48_u8981_u8FD9_u4E48_u505A_uFF1F_uFF08_u4F30_u8BA1_u662F_u770B_u770B_u6211_u6CA1_u6709_u5173_u6CE8_u8FD9_u4E9B_u4E8B_u513F_uFF09" class="headerlink" title="第六个，微信小程序的实现原理是啥？为什么要这么做？（估计是看看我没有关注这些事儿）"></a>第六个，微信小程序的实现原理是啥？为什么要这么做？（估计是看看我没有关注这些事儿）</h4><p>我说大概是在类似Html的基础上又封装实现了一套自己的东西，然后他去帮我们调用原生的东西。因为我当时参加的一线下活动里看到过，微信小程序可以在web页面里调试。</p>
<p>至于为什么，我猜是为了维护自己的微信生态啥的，也更好的和微信本身交互</p>
<h4 id="u7B2C_u4E03_u4E2A_uFF0C_u600E_u4E48_u53BB_u4F18_u5316_u6D41_u91CF_u7684_u7684_u95EE_u9898_uFF0C_u6216_u8005_u7535_u91CF_u7684_u95EE_u9898_3F"><a href="#u7B2C_u4E03_u4E2A_uFF0C_u600E_u4E48_u53BB_u4F18_u5316_u6D41_u91CF_u7684_u7684_u95EE_u9898_uFF0C_u6216_u8005_u7535_u91CF_u7684_u95EE_u9898_3F" class="headerlink" title="第七个，怎么去优化流量的的问题，或者电量的问题?"></a>第七个，怎么去优化流量的的问题，或者电量的问题?</h4><p>网络缓存，然后是缓存时效性问题。然后就是说道ETag来标志缓存是否要更新<br>电量的话，只能用intrument去分析app里那些地方占用的大量的内存，或者耗时的任务，动画之类的。</p>
<h4 id="u7B2C_u516B_u4E2A_uFF0C_u5BF9MVVM_u600E_u4E48_u770B_uFF1F_u6709_u5565_u7F3A_u70B9_uFF1F"><a href="#u7B2C_u516B_u4E2A_uFF0C_u5BF9MVVM_u600E_u4E48_u770B_uFF1F_u6709_u5565_u7F3A_u70B9_uFF1F" class="headerlink" title="第八个，对MVVM怎么看？有啥缺点？"></a>第八个，对MVVM怎么看？有啥缺点？</h4><p>我说这个主要就是View层和Model层的双向绑定问题。RAC就是使双向绑定的事情变得更简单了。缺点的话，我说因为数据绑定可能会让bug更难调试吧，而且数据绑定也比较复杂，耗费内存。RAC的问题也是，出了问题比较难调试以及内存问题。</p>
<h4 id="u7ED3_u5C3E"><a href="#u7ED3_u5C3E" class="headerlink" title="结尾"></a>结尾</h4><p>其实他们问的是多数都是大平台的APP里，通常都需要去解决的一些难点，以及你怎么去应对这些事。除了这些问题，还有一些零零散散的，比如微信的聊天记录表，要你去设计应该怎么去设计，微信的聊天应该怎么去实现啥的。今天也是明白了自己的差距在哪儿——视野太狭窄了。很多原理性的东西都需要去钻研，很多技术难点也需要去攻克。共勉吧！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/04/消息机制和Category小记/" itemprop="url">
                  消息机制和Category小记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-04T20:42:30+08:00" content="2016-10-04">
              2016-10-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">杂谈</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在学习OC到一定阶段的时候，大部分都会接触到OC的底层机制。然后就会碰到Runtime、RunLoop这些名词。我自己在学习的过程中，第一次是通过一个“神奇的视频”开始，随后一段时间，就看到了不计其数的博客开始记录自己的Runtime学习之旅。我以前一直觉得，别人写过了的东西其实都没有必要再写了。不过最近反思，这些东西更多的时候是自己学习过程的记录，因为了解了知识点之后，并不一定能完整的诉诸文字或者使人昭昭。<code>I see and I forget, I hear and I remember, I do and I understand！</code></p>
<h4 id="u6D88_u606F_u673A_u5236"><a href="#u6D88_u606F_u673A_u5236" class="headerlink" title="消息机制"></a>消息机制</h4><p>消息发送机制是runtime的重要组成部分。明白了一个消息的完整发送过程，对oc对象的本质以及runtime肯定会有一个宏观的了解。</p>
<p>首先是“对象”，OC的对象其实就是一个含有isa指针的结构体。包括<code>实例对象(instance)</code>，<code>类对象(class)</code>，<code>元类对象(meta class)</code>。实例对象包含实例变量、类对象包含实例方法（’ - ‘号），元类对象包含类方法。当然，这些对象中不仅仅包含这些东西。但是对于理解消息机制，知道这些大概的差不多了，以下是简单的图解。<br><img src="http://7xpoeq.com1.z0.glb.clouddn.com/runtime_classes.png" alt="class"></p>
<p>所以在对一个对象发消息的时候，如果是向实例对象发送消息，则是在他的类对象中找([aFoo bar])；向类对象发送消息则是在元类中找([Foo bar])。</p>
<p>寻找方法是怎样的过程，则需要看一下objc_msgSend的源码<br>（<a href="http://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">源码下载地址</a>）</p>
<p>下载一个比较新的（我下的是objc4-680），在工程中全局搜索<code>objc_msgSend(</code>，你会发现有有不同版本的objc_msgSend，而且全都是汇编。很显然这肯定是不同CPU下的优化，不过大概的流程都是一样的。objc_msgSend的方法原型是<code>id objc_msgSend(id self, SEL _cmd, ...)</code>。消息发送的流程，简单的一句话概括：方法的接收者在isa指向的对象的‘方法列表’中搜寻SEL对应的IMP，在父类不为nil的情况下继续沿着继承体系向上找。如果最终仍然找不到则会走消息转发流程。</p>
<p>像这种几乎每秒要调用上万次的方法，肯定会极度优化。缓存是必要的，不然每次走上面一通流程没法儿玩。还有像《52个方法》中说的“<a href="https://zh.wikipedia.org/wiki/尾调用" target="_blank" rel="external">尾调用优化</a>“。以下是objc-msg-i386s中的方法（x86_64的和这个不一样，思路肯定是一样的）<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span> id objc_msgSend(id self, SEL	_cmd,...);</span><br><span class="line"> <span class="keyword">*</span></span><br><span class="line"> <span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line"></span><br><span class="line">	ENTRY	_objc_msgSend</span><br><span class="line">	MESSENGER_START</span><br><span class="line">	CALL_MCOUNTER</span><br><span class="line"></span><br><span class="line">// load receiver and selector</span><br><span class="line">	movl    selector(%esp), %ecx</span><br><span class="line">	movl	self(%esp), %eax</span><br><span class="line"></span><br><span class="line">// check whether selector is ignored</span><br><span class="line">	cmpl    $ kIgnore, %ecx</span><br><span class="line">	je      LMsgSendDone		// return self from %eax</span><br><span class="line"></span><br><span class="line">// check whether receiver is nil </span><br><span class="line">	testl	%eax, %eax</span><br><span class="line">	je	LMsgSendNilSelf</span><br><span class="line"></span><br><span class="line">// receiver (in %eax) is non-nil: search the cache</span><br><span class="line">LMsgSendReceiverOk:</span><br><span class="line">	movl	isa(%eax), %edx		// class = self-&gt;isa</span><br><span class="line">	CacheLookup WORD_RETURN, MSG_SEND, LMsgSendCacheMiss</span><br><span class="line">	xor	%edx, %edx		// set nonstret for msgForward_internal</span><br><span class="line">	MESSENGER_END_FAST</span><br><span class="line">	jmp	<span class="keyword">*</span>%eax</span><br><span class="line"></span><br><span class="line">// cache miss: go search the method lists</span><br><span class="line">LMsgSendCacheMiss:</span><br><span class="line">	MethodTableLookup WORD_RETURN, MSG_SEND</span><br><span class="line">	xor	%edx, %edx		// set nonstret for msgForward_internal</span><br><span class="line">	jmp	<span class="keyword">*</span>%eax			// goto <span class="keyword">*</span>imp</span><br><span class="line"></span><br><span class="line">// message sent to nil: redirect to nil receiver, if any</span><br><span class="line">LMsgSendNilSelf:</span><br><span class="line">	// %eax is already zero</span><br><span class="line">	movl	$0,%edx</span><br><span class="line">	xorps	%xmm0, %xmm0</span><br><span class="line">LMsgSendDone:</span><br><span class="line">	MESSENGER_END_NIL</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">// guaranteed non-nil entry point (disabled for now)</span><br><span class="line">// .globl _objc_msgSendNonNil</span><br><span class="line">// _objc_msgSendNonNil:</span><br><span class="line">// 	movl	self(%esp), %eax</span><br><span class="line">// 	jmp     LMsgSendReceiverOk</span><br><span class="line"></span><br><span class="line">LMsgSendExit:</span><br><span class="line">	END_ENTRY	_objc_msgSend</span><br></pre></td></tr></table></figure></p>
<p>汇编代码不理解没关系，就看注释就知道大概是干嘛的，但是需要注意一下他的方法调用顺序，不然很容易迷失在源码里:D。主要就是两件事情查找缓存和查找MethodList，之前还有关于nil的处理。刨根稳定的事情，已经有人做的很好了，推荐看这个</p>
<p><a href="http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/" target="_blank" rel="external">Objective-C 消息发送与转发机制原理</a></p>
<p>有些地方看不懂，明白大概流程就行了:D。如果在继承体系中都没找到，剩下的就是消息转发的流程。消息主要转发分俩流程</p>
<ol>
<li>问你能不能动态的给这个selector添加一方法？或者你给我一个别的target区响应这个操作也好啊（可以这样实现组合模式）（这个步骤也称为“快速消息转发”）</li>
<li>如果你做不到1，那么就只能交给someoneelse来处理了（标准消息转发）</li>
</ol>
<p>这些在objc-class.mm中能都看到完整的处理过程</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> _class_resolveMethod</span><br><span class="line"><span class="keyword">*</span> Call +resolveClassMethod or +resolveInstanceMethod.</span><br><span class="line"><span class="keyword">*</span> Returns nothing; any result would be potentially out-of-date already.</span><br><span class="line"><span class="keyword">*</span> Does not check if the method already exists.</span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">void _class_resolveMethod(Class cls, SEL sel, id inst)</span><br><span class="line">&#123;</span><br><span class="line">    if (! cls-&gt;isMetaClass()) &#123;</span><br><span class="line">        // try [cls resolveInstanceMethod:sel]</span><br><span class="line">        _class_resolveInstanceMethod(cls, sel, inst);</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">        // try [nonMetaClass resolveClassMethod:sel]</span><br><span class="line">        // and [cls resolveInstanceMethod:sel]</span><br><span class="line">        _class_resolveClassMethod(cls, sel, inst);</span><br><span class="line">        if (!lookUpImpOrNil(cls, sel, inst, </span><br><span class="line">                            NO/<span class="keyword">*</span>initialize<span class="keyword">*</span>/, YES/<span class="keyword">*</span>cache<span class="keyword">*</span>/, NO/<span class="keyword">*</span>resolver<span class="keyword">*</span>/)) </span><br><span class="line">        &#123;</span><br><span class="line">            _class_resolveInstanceMethod(cls, sel, inst);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这儿区分了是类对象还是元类对象，分别对应实例方法和类方法的resolution(解析)。源码里的注释指出了这会调用我们实际开发中的哪个方法。如果是Meta-Class，在没有找到IMP的情况下，依然去尝试实例方法，这可能是为了确保你有没有正确添加IMP。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/<span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span></span><br><span class="line"><span class="keyword">*</span> lookUpImpOrNil.</span><br><span class="line"><span class="keyword">*</span> Like lookUpImpOrForward, but returns nil instead of _objc_msgForward_impcache</span><br><span class="line"><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span><span class="keyword">*</span>/</span><br><span class="line">IMP lookUpImpOrNil(Class cls, SEL sel, id inst, </span><br><span class="line">                   bool initialize, bool cache, bool resolver)</span><br><span class="line">&#123;</span><br><span class="line">    IMP imp = lookUpImpOrForward(cls, sel, inst, initialize, cache, resolver);</span><br><span class="line">    if (imp == _objc_msgForward_impcache) return nil;</span><br><span class="line">    else return imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在看<code>IMP lookUpImpOrNil(Class cls, SEL sel, id inst, 
                   bool initialize, bool cache, bool resolver)</code>的时候，记得把参数带进去看，因为这就是<code>_class_resolveMethod</code>消息转发第一步的一个逻辑处理，不然容易在<code>lookUpImpOrForward</code>绕半天。<code>lookUpImpOrForward</code>是一个标准的查找IMP的过程，里面带有了各种各样的检查，查找缓存、判断class是不是被释放了、在父类里找一通…，而lookUpImpOrNil,没找到ruturn nil，并把imp设为<code>_objc_msgForward_impcache</code>缓存起来（对应传进来的SEL）。</p>
<figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">	//摘自lookUpImpOrForward方法</span><br><span class="line">    // <span class="type">No</span> implementation found, <span class="keyword">and</span> <span class="keyword">method</span> resolver didn't help. </span><br><span class="line">    // <span class="type">Use</span> forwarding.</span><br><span class="line"></span><br><span class="line">    _cache_addForwardEntry(cls, sel);</span><br><span class="line">    ....</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="type">void</span> _cache_addForwardEntry(<span class="type">Class</span> cls, <span class="type">SEL</span> sel)</span><br><span class="line">&#123;</span><br><span class="line">    cache_entry *smt;</span><br><span class="line">  </span><br><span class="line">    smt = (cache_entry *)malloc(sizeof(cache_entry));</span><br><span class="line">    smt-&gt;name = sel;</span><br><span class="line">	//把这个imp设为缓存</span><br><span class="line">    smt-&gt;imp = _objc_msgForward_impcache;</span><br><span class="line">    <span class="keyword">if</span> (! _cache_fill(cls, (<span class="type">Method</span>)smt, sel)) &#123;  // fixme hack</span><br><span class="line">        // <span class="type">Entry</span> <span class="keyword">not</span> added to cache. <span class="type">Don</span>'t leak the <span class="keyword">method</span> struct.</span><br><span class="line">        free(smt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<br><code>void _class_resolveInstanceMethod</code>方法里，就会找到这个缓存的方法，并重新调用一次objc_msgSend,然后出发消息转发流程。</p>
<p>也就是在这一步添加的方法，会被缓存起来，下次发送这个SEl的时候都不会触发这个转发步骤了，直接在缓存中就找到了对应的实现。所以在这一步处理消息转发的最好的。<br>最终触发的方法是 <code>id _objc_msgForward(id self, SEL _cmd,...)</code>。接下来就是完整的消息转发流程。 这个方法的源码是汇编写的，全局搜索<code>_objc_msgForward(</code>则可以找到。</p>
<p>之后就是给你一次机会转发给另外一个对象，不过以这样的方式处理，方法名，参数信息啥的都不能改变，和resolve方式的效果是一样的，而且还不如之前的处理方式（前一步有缓存）。如果这步返回nil，那么接下来就是我们常见的<code>方法签名+invocation调用</code>的完整转发方式。</p>
<h4 id="u4E3A_u4EC0_u4E48Category_u4E2D_u4E0D_u80FD_u6DFB_u52A0_u5C5E_u6027"><a href="#u4E3A_u4EC0_u4E48Category_u4E2D_u4E0D_u80FD_u6DFB_u52A0_u5C5E_u6027" class="headerlink" title="为什么Category中不能添加属性"></a>为什么Category中不能添加属性</h4><p>其实这个问题是Category的加载问题。在美团的“<a href="http://tech.meituan.com/DiveIntoCategory.html" target="_blank" rel="external">深入理解Objective-C：Category</a>“中对Category进行了毫分缕析，讲的非常明白，看完之后必定会受益良多。对上述问题也有提及</p>
<blockquote>
<p>但是category则完全不一样，它是在运行期决议的。<br>就category和extension的区别来看，我们可以推导出一个明显的事实，extension可以添加实例变量，而Category是无法添加实例变量的（因为在运行期，对象的内存布局已经确定，如果添加实例变量就会破坏类的内部布局，这对编译型语言来说是灾难性的）。</p>
</blockquote>
<p>从文章里的源码分析来看，runtime是在运行期间去加载Category里添加的方法。小提一下，在Category添加如下代码<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="preprocessor">#import <span class="title">"ViewController.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">ViewController</span> (<span class="title">Test</span>)</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">strong</span>, <span class="keyword">nonatomic</span>) <span class="built_in">NSString</span> *name;</span><br><span class="line">- (<span class="keyword">void</span>)foo;</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure></p>
<p>他只会生成name的setter/getter方法的声明，并没有他俩的实现，更不会像在@interface 或者 extension里边那样去自动生成_name实例变量。并且，编译器也没有警告⚠️。因为他认为你会在运行时添加他们的实现，或者在被外部引用的时候会实现方法。</p>
<p>在<a href="https://developer.apple.com/reference/objectivec/1657527-objective_c_runtime#//apple_ref/c/func/class_addMethod" target="_blank" rel="external">官方的文档</a>中,向类添加成员变量的方法是<code>class_addIvar</code>。这个方法只能在<code>objc_allocateClassPair</code><br>和<code>objc_registerClassPair</code>之间调用。也就是只能在类的构造期间去添加。而</p>
<blockquote>
<p>This function may only be called after objc_allocateClassPair and before objc_registerClassPair. Adding an instance variable to an existing class is not supported.</p>
</blockquote>
<p>向一个已经存在的基类添加成员变量，会导致已经构造出来的实例无法使用。第一个问题里已经指出，”成员变量是被包含在类实例里的”。换句话说，如果你修改了基类的结构，那么构建出来的实例就不符合类的定义了。而方法是存在objc_class里的。添加方法并不会影响类的结构布局。</p>
<p>用objc_associateObject关联的对象，是在一个全局的Hash表里边存储的，并不是直接添加到类的结构里。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/25/一些关于ChildViewController的问题/" itemprop="url">
                  关于ChildViewController
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-05-25T15:13:54+08:00" content="2016-05-25">
              2016-05-25
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/UIKit/" itemprop="url" rel="index">
                    <span itemprop="name">UIKit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>偶然间看到了几个问题，都是关于 childViewController,发现有一些点自己理解的可能不够到位，对一些概念也是模糊不清，而且childViewController在实际的开发工作中，是一个解耦的利器，所以值得对 childViewController 研究一下。</p>
<p>文章围绕四个问题：</p>
<ol>
<li>What is ChildViewController？</li>
<li>ChildViewController 的加载时机</li>
<li>viewDidLoad, viewWillAppear, viewWillDisappear等这些方法在 childViewController 的调用时机</li>
<li>memeryWarning 时 childViewController 会如何？parentViewController 是否会释放一些childViewController?</li>
</ol>
<h3 id="1-What_is_ChildViewController_3F"><a href="#1-What_is_ChildViewController_3F" class="headerlink" title="1.What is ChildViewController?"></a>1.What is ChildViewController?</h3><p>先理解一个宏观上的概念 —— Container ViewController。</p>
<blockquote>
<p>Container view controllers are a way to combine the content from multiple view controllers into a single user interface. Container view controllers are most often used to facilitate navigation and to create new user interface types based on existing content. Examples of container view controllers in UIKit include <code>UINavigationController</code>, <code>UITabBarController</code>, and <code>UISplitViewController</code>, all of which facilitate navigation between different parts of your user interface. —— <strong>View Controller Programming Guide for iOS</strong></p>
</blockquote>
<p>由此可知，Container ViewController 其实是一个管理其他ViewController的视图的一个Controller。文档中指出，UIKit 中UITabBarController 等这些Controller，其实都可以称作Container ViewController。 比如 UITabbarController, 通过比对 viewControllers 属性 和 childViewControllers 属性可知，其实这二者是一样的。在呈现上最为直观的应该是Pad开发中专用的UISplitViewController</p>
<p>图 1-1：UISplitViewController</p>
<p><img src="http://7xpoeq.com1.z0.glb.clouddn.com/VCPG-split-view-inerface_5-2_2x.png" alt="UISplitViewController"></p>
<p>根据这些概念，其实 childViewController 就是被管理的控制器（解释起来略显中二）。 要构建一个自己的Container ViewController，关键是要理解 Container 和 Contained ViewController 之间的关系。了解了二者的关系，才能帮助你理解他们二者的内容该如何显示，Container是内在是如何管理 Children 的。</p>
<p>在StoryBoard中，拖一个 ‘ContainerView’ 就可以直接构建起这样的’Parent-Child‘关系了。像这样：</p>
<p>图 1-2：StoryBoard 中添加 ContainerView</p>
<p><img src="http://7xpoeq.com1.z0.glb.clouddn.com/StoryBoard-Container.png" alt="Alt text"></p>
<p>左图中的Container部分，相当于是一个呈现右边 childViewController 内容的 placeholder 对象。当你打算把这个 ‘placeholder’ 作为 IBOutlet 拖到对应的控制器里边时候，会发现，他是一个 UIView对象，然后你就可以对他加上相应的 size 或者 constraint 来适应屏幕大小（这是不是也是一种适配的方式呢？）。需要注意的一点。这个 placeholder 呈现的是 childViewController 的 <code>rootView</code> ，也就是 vc.view 这个属性。</p>
<p>而如果你是通过代码的方式去创建这样的 parent-child 关系，你需要以下4个步骤：</p>
<ol>
<li>调用 Parent 的 addChildViewController: 方法</li>
<li>把 Child 的 rootView 加到 Parant 的 视图层级上，不一定是 rootView</li>
<li>设置 Child 的 frame。可以添加约束，但是要先 addSubview:</li>
<li>调用 Child 的 didMoveToParentViewController: 方法</li>
</ol>
<p>Listing 1-1: 添加一个 childViewController 到 Container 上</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ViewControllerB *childVc = [[ViewControllerB alloc] init]<span class="comment">;</span></span><br><span class="line">[self addChildViewController:childVc]<span class="comment">;</span></span><br><span class="line">childVc.view.frame = CGRectMake(0, 0, 100, 100)<span class="comment">;</span></span><br><span class="line">[self.view addSubview:childVc.view]<span class="comment">;</span></span><br><span class="line">[childVc didMoveToParentViewController:self]<span class="comment">;</span></span><br></pre></td></tr></table></figure>
<p>addChildViewController: 只会调用 childViewController 的 willMoveToParentViewController: ，文档中如是说（参考List 1-1）：</p>
<blockquote>
<p>In the preceding example, notice that you call only the didMoveToParentViewController: method of the child. That is because the addChildViewController: method calls the child’s willMoveToParentViewController: method for you. The reason that you must call the didMoveToParentViewController: method yourself is that the method cannot be called until after you embed the child’s view into your container’s view hierarchy.</p>
</blockquote>
<p>didMoveToParentViewController: 这个方法，是为了告知 childViewController<br>它现在有一个 parent view controller。你可以在你的 child 中重载这个方法，如果他需要知道这个 notice 的话。不过文档中指出</p>
<blockquote>
<p>If you are implementing your own container view controller, it must call the didMoveToParentViewController: method of the child view controller after the transition to the new controller is complete or, if there is no transition, immediately after calling the addChildViewController: method.</p>
</blockquote>
<p>也就是你一定要调用这个方法啊！不过说实在的，我找了半天也没有找到为什么一定要调用这两个方法。猜测也就是可能会传递一些系统的事件给 childViewController 。后来我发现了 stackOverFlow 上 <a href="http://stackoverflow.com/questions/17192005/what-does-addchildviewcontroller-actually-do" target="_blank" rel="external">What does addChildViewController actually do?</a> 关于这个问题的讨论，才更加了解，这系列方法的作用。</p>
<h3 id="2-ChildViewController__u7684_u52A0_u8F7D_u65F6_u673A"><a href="#2-ChildViewController__u7684_u52A0_u8F7D_u65F6_u673A" class="headerlink" title="2.ChildViewController 的加载时机"></a>2.ChildViewController 的加载时机</h3><p>这个问题其实有点模棱两可。</p>
<p>这是在 InterfaceBuild 中的情况。</p>
<blockquote>
<p>When you load a view controller with one or more container views, Interface Builder also loads the child view controllers associated with those views. The children must be instantiated at the same time as the parent so that the appropriate parent-child relationships can be created.</p>
</blockquote>
<p>如果是以 Programmatically 方式，那么是在把 child 加载到 Parent 的视图层级关系时候(<code>[parent addSubView:child.view]</code>)，才开始走 childViewController 的生命周期方法。</p>
<h3 id="3-viewDidLoad_2C_viewWillAppear_2C_viewWillDisappear_u7B49_u8FD9_u4E9B_u65B9_u6CD5_u5728_childViewController__u7684_u8C03_u7528_u65F6_u673A"><a href="#3-viewDidLoad_2C_viewWillAppear_2C_viewWillDisappear_u7B49_u8FD9_u4E9B_u65B9_u6CD5_u5728_childViewController__u7684_u8C03_u7528_u65F6_u673A" class="headerlink" title="3.viewDidLoad, viewWillAppear, viewWillDisappear等这些方法在 childViewController 的调用时机"></a>3.viewDidLoad, viewWillAppear, viewWillDisappear等这些方法在 childViewController 的调用时机</h3><p>这个问题和上面那个其实有重叠的部分。还是要分 InterfaceBuild 和 Programmatically 俩种方式。</p>
<p>如果是在 InterfaceBuild 中，按照问题2引入的文档描述，parent 和 child 是同时加载的。二者的生命周期方法调用顺序如下(ViewControllerB 为 child)：</p>
<p>图:1-3 StoryBoard中Parent-Child生命周期<br><img src="http://7xpoeq.com1.z0.glb.clouddn.com/IB-LifeCycle.png" alt="Alt text"></p>
<p>如果是以 Programmatically 方式在 Parent 的 viewDidLoad: 中添加 childViewController 的话，结果如下：</p>
<p>图:1-3 Programmatically中Parent-Child生命周期<br><img src="http://7xpoeq.com1.z0.glb.clouddn.com/Program-LifeCycle.png" alt="Alt text"></p>
<p>通过二者的比较，发现 Parent 和 Child 其实都是同一时候收到 System Event 的。而且，基本上都是 Parent 的方法先被调用。文档中有这样一句话：</p>
<blockquote>
<p>The parent-child relationship ensures that the children receive any relevant system messages.</p>
</blockquote>
<p>有点需要注意，上面已经提到，Child 是在被 add 到 Parent 的视图层级关系时候才开始 LifeCycle 方法的。并不是在 didMoveToParentViewController: 时。</p>
<h3 id="4-Memory_Warning"><a href="#4-Memory_Warning" class="headerlink" title="4.Memory Warning"></a>4.Memory Warning</h3><p>首先我们得知道，ViewController 自身在收到 Memory Warning 的时候是怎么处理的。 原则上，如果当前视图已经加载到了内存中，并且没有显示在 window 上，那么可以将其内部的的一些资源释放。在 iOS 6 以下，ViewController 在收到内存警告的时候，默认会执行 <code>self.view = nil</code>操作的。而 iOS 6+ 即使没有显示在 window 上，系统也不会默认释放 view。</p>
<p>我们回到这个问题上：<strong>‘memeryWarning 时 childViewController 会如何？parentViewController 是否会释放一些childViewController’?</strong> 在 parent-child 的关系体系中（就是已经以正确的构建），childViewController 是可以收到内存警告的。如果仅仅是把 child.view 加到了 parent 的 view hierarchy 中，肯定是收不到。</p>
<p>那 parent 是否会 释放自己的 childViewController？经过测试（iOS 9），发现并不会。</p>
<p>当然，如果需要的话，你也可以在 childViewController 里面去做一些释放资源的工作，原则还是如上所说。</p>
<p>小结一下，研究这个问题虽然有点累人，不过还是玩的开心。:D</p>
<p>参考资源：<br><a href="https://developer.apple.com/library/ios/featuredarticles/ViewControllerPGforiPhoneOS/ImplementingaContainerViewController.html#//apple_ref/doc/uid/TP40007457-CH11-SW1" target="_blank" rel="external">https://developer.apple.com/library/ios/featuredarticles/ViewControllerPGforiPhoneOS/ImplementingaContainerViewController.html#//apple_ref/doc/uid/TP40007457-CH11-SW1</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/02/04/被忽视的iOS架构模式-MVP/" itemprop="url">
                  被忽视的iOS架构模式-MVP
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-02-04T21:35:50+08:00" content="2016-02-04">
              2016-02-04
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/设计杂谈/" itemprop="url" rel="index">
                    <span itemprop="name">设计杂谈</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前一段时间，业界关于iOS架构模式的讨论可谓是如火如荼。从讨伐人人得而诛之的MVC开始，MVCS、MVVM、MVP等设计的思想，普天盖地的出现在iOSer的视野中。由于RAC的出现，MVVM这个被大家讨论的最多的词汇，更是如日中天。从基础的MVVM教程开始（iOS 程序猿的，英文好的朋友可以看看Ray上的Toturial），乃至到批判的文章（唐巧的《被神话的MVVM》），一应俱全。但是关于其他的MVP此类的，大家都是用来做为比较的例子，一笔带过。在我的阅读的范围之内，好像没有见过有谁去详细的解释了一下，至少侧重点不在于此。鉴于此，发表一下个人对于MVP的看法，并且附上相应的Demo。</p>
<p>我们知道，上述所有的设计模式的目的，都是为了解放负担过重的Controller。超过了500行的Controller，基本上就要靠搜索来定位代码了，于己于人，都非常不友好。<br>MVP，不是Most Valuable Player，是从MVC思想中，淡化了Controller的概念，把Controller的大部分业务逻辑，转交到Presenter中，弱化了Controller和Model、View之间的强依赖关系。Presenter可以剥离Controller中<code>View的事件处理</code>，同时也可以<code>负责与Model</code>的交互，Controller自身的一些比如Controller之间的跳转，还是自身负责。这儿的Model，我们可以理解成一个Manager，一个操作数据层（网络or本地），不仅仅是一个继承自NSObject的对象。相比于MVVM，缺少了双向绑定的机制，好处是不会有那么高的耦合，提高了自身的可扩展性和灵活性。</p>
<p><strong>MVP简意</strong><br><img src="http://7xpoeq.com1.z0.glb.clouddn.com/MVP%E7%AE%80%E6%84%8F.jpg" alt="MVP简意"></p>
<p>其中还有好多的数据回调、传递。</p>
<p>我看完很多文章之后仅仅有了一个概念，“哦，原来是这么回事”，然后想写一个Demo实践一下，感觉又远远不止如此。不知道有多人是和我这样。所以，我参照各方资料写了一个我理解的中的<a href="https://github.com/kRadius/MVPDemo" target="_blank" rel="external">示例</a>。实现从网络获取json数据，然后点击进入详细界面这么一个需求。</p>
<p><strong>ListViewController 的结构</strong><br><img src="http://7xpoeq.com1.z0.glb.clouddn.com/MVP_1_1.jpg" alt="ListViewController的结构"></p>
<p>可以看到，VC直接持有了Presenter和DataManager（放下手中的西瓜刀，这DataManager其实是给Presneter用的）。还有一个DataSource是用来分离TableView的代理方法，这个给ViewContrller减负的技巧，objc.io开篇就讲了，有兴趣的可以回去翻阅。UIActivityIndicatorView就是象征VC可能持有的一系列变量（诸如刷洗按钮等）。ListViewProtocol是把ViewController里边的一些处理定义成协议，交给Presenter。做这些所有的目的，都是为了给VC瘦身，合理的减负。</p>
<p><code>ListViewProtocol</code>中，把VC中可以或者需要分离的逻辑，定义成协议。<br><img src="http://7xpoeq.com1.z0.glb.clouddn.com/MVP_2.jpg" alt="ListViewProtocol"><br>之前我们看到，其实是ListViewController实现了这个协议，只不过这些协议方法的调用地方是在Presenter里。比如说，在请求开始之前，-(void)startLoading。获取到了数据之后，就调用-(void)receivedListData:(NSArray *)array，然后刷新tableView之类的事情就可以做了。因为有些事情还是适合在VC里边自个儿做。</p>
<p>DataManager在这需求里边就需要有一个获取数据的方法，用的是block回调。<br><img src="http://7xpoeq.com1.z0.glb.clouddn.com/MVP_4.jpg" alt="DataManager"><br>另外那个DataArray可以让VC去持有。</p>
<p>最关键的<code>Presenter</code><br><img src="http://7xpoeq.com1.z0.glb.clouddn.com/MVP_3.jpg" alt="Presenter实现"><br>在MVP里边，P就是核心的调度者。干的就是以前VC的活。前面提到，DataManager其实是最主要是给Presenter用的。Prensenter需要有个可以初始化这俩变量的地方，并且发起数据请求。Demo就是在config这个方法里做的。有一点需要注意的是，他们之间的<code>循环引用问题</code>，该用weak的地方就用weak。这里解释一下为什么定义那么多协议。我觉得协议里的方法可以理解成需求，然后甭管你是谁，只要能够实现这些需求，就能够成为Presenter，成为Manager。这样不知道算不算是一种解耦的方式。</p>
<p>Demo里的核心部分就是这些了，详情页面的和这个差不多，看到了工程里边的东西，一下就会明白的。</p>
<p>总的来说，MVP提供了良好的灵活性和扩展性，对于写单元测试的来说，也是较为可控。不过，于我们所见，代码量多了不少，另外也没有那View和Model的绑定机制。还是那句话，没有最好的设计模式，合适自己需求的才是最好的。</p>
<p>PS：Demo里的数据来自豆瓣，偶尔会有福利。玩的开心 :D</p>
<p>请尊重原创,保持原链接 :D</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/12/30/something-about-hexo/" itemprop="url">
                  搭建hexo躺过的坑
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2015-12-30T17:56:29+08:00" content="2015-12-30">
              2015-12-30
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/hexo/" itemprop="url" rel="index">
                    <span itemprop="name">hexo</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>辛苦的整了一个下午，终于搭建了一个自己的小窝，还是比较开心的。如果你能看到这个文章，那么你肯定知道为什么自己要去做搭建博客这样一件事（这逻辑稍显诡异）。我相信每一个有点追求的程序员都会去写点东西（并没有鄙视超凡脱俗又不喜欢写东西的大神的意思），一方面回馈社区，另一方面也可以提高自己的能力。</p>
<p>搭建hexo的过程中，一般都不会一帆风顺，这也正常，这就和我们写代码会遇到bug一样，搭个这玩意儿，就依葫芦画瓢，按部就班就行，说来确实没什么大不了的。不过我猜，很多人hexo的第一篇博客都是记录自己躺过的坑: ]（前人勤栽树，后人好乘凉）。<br>    之前那些从安装node到注册github这些的，前辈们已经讲的很清楚了。不再重复以凑篇幅，在这提供一些链接吧。</p>
<h6 id="u94FE_u63A5"><a href="#u94FE_u63A5" class="headerlink" title="链接"></a>链接</h6><ul>
<li>金石开 <a href="http://www.cnblogs.com/zhcncn/p/4097881.html" target="_blank" rel="external">http://www.cnblogs.com/zhcncn/p/4097881.html</a></li>
<li>潘柏信 <a href="/leopardpan.github.io">leopardpan.github.io</a></li>
<li>wsgzao <a href="http://wsgzao.github.io/post/hexo-guide/#前言" target="_blank" rel="external">http://wsgzao.github.io/post/hexo-guide/</a></li>
</ul>
<p>按照他们的来，差不多能搭起来，而且里面也记录了一些坑，如果自己遇到了，可以比照比照。</p>
<p>我遇到的就是一个坑就是少这少那儿的插件，这个潘的博客里边已经写的比较清楚了。</p>
<p>第二个坑，确实坑！配置文件的时候一定要注意”<strong>YAML YAML YAML</strong>“（Yet Another Markup Language）语法。我按照潘的写法更改type之类配置的时候，一不小心在冒号之后没有加空格。然后hexo deploy的时候没有啥反应，本着<code>&quot;Unix没有消息就是最好的消息&quot;</code>的原则，我还以为这样就部署成功了。然后上自己的github一看，蒙了。然后各种各样的折腾，甚至我把public文件夹下的东西自己给上传到了git（这样还真可以显示），花了比前面那些工作还多的时间，最后发现是少了一空格- -！（这种感觉相信你也体会过: ]）。部署成功的样子应该是这样的</p>
<p><img src="http://7xpoeq.com1.z0.glb.clouddn.com/1.pic_hd.jpg" alt="Alt text"></p>
<p>而不是啥都没显示 - - !。</p>
<p>最后，既然你要写东西，MarkDown还是要会一点的。这个其实都很简单，记住一些常用的就行了。你以前没用过是吗？好，收好这个链接 <a href="http://wowubuntu.com/markdown/。" target="_blank" rel="external">http://wowubuntu.com/markdown/。</a></p>
<p>这么多？嫌麻烦？那就用这个吧 <a href="https://maxiang.io/" target="_blank" rel="external">https://maxiang.io/</a> 。那我上哪儿去写啊？Sublime 啥的随便你自己挑。不过同事推荐的这个叫马克飞象的，Evernote出品，个人觉得很nice啊！喜欢的可以尝试一下。给出下载链接吧，谁叫我是雷锋呢？</p>
<ul>
<li><a href="http://maxiang.info/client_zh" target="_blank" rel="external">马克飞象</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://7xpoeq.com1.z0.glb.clouddn.com/avatar.png"
               alt="Radius" />
          <p class="site-author-name" itemprop="name">Radius</p>
          <p class="site-description motion-element" itemprop="description">夫博观而约取，厚积而薄发</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Radius</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  


  



  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  



  
  
  

  
  


</body>
</html>
